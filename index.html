<html>

  <head>
    <title>jQuery Mobile page</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/TOBASIC.css" />
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/jquery.mobile.icons.min.css" />

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" /> 
  </head>
  
  <body>
    <div style="align: center;">
      <button onclick="requestMotionPermission();">Get permission and start sensing</button>
      <button onclick="stopDeviceMotion();">Stop</button>
    </div>
    <h2>Activity Recognition</h2>
    <h3>(3) Classification result</h3>
    <ul>
    <li> Result: <span id="current_result" style="color:red;font-size:2.0em; font-weight: bold; border-top: 1px solid black; border-bottom: 1px solid black;">null</span> </li> 
    </ul>
    
    <h3>(2) Features for this time window</h3>
    <ul>
    <li> min x: <span id="xmin">0</span> </li>
    <li> max x: <span id="xmax">0</span> </li>
    <li> ave x: <span id="xave">0</span> </li>
    <li> kurtosis x: <span id="xkurtosis">0</span> </li>
    <li> sumabs x: <span id="xsumabs">0</span> </li>
		

    <li> min y: <span id="ymin">0</span> </li>
    <li> max y: <span id="ymax">0</span> </li>
    <li> ave y: <span id="yave">0</span> </li>
	<li> kurtosis y: <span id="ykurtosis">0</span> </li>
    <li> sumabs y: <span id="ysumabs">0</span> </li>

    <li> min z: <span id="zmin">0</span> </li>
    <li> max z: <span id="zmax">0</span> </li>
    <li> ave z: <span id="zave">0</span> </li>
	<li> kurtosis z: <span id="zkurtosis">0</span> </li>
    <li> sumabs z: <span id="zsumabs">0</span> </li>
    </ul>

    <h3>(1) Raw sensor values for this time window</h3>
    <ul>
    <li> X: <span id="accel-x">0</span> </li> 
    <li> Y: <span id="accel-y">0</span> </li> 
    <li> Z: <span id="accel-z">0</span> </li>
    </ul>
    
    <textarea id="raw-data" style="width:90%;height:50vh;"></textarea>

    <hr/>

    <h2>レポート記述欄 / Report</h2>
    <ul>
      <li>Name / 氏名:飯塚涼</li>
      <li>Department / 学部:環境情報学部</li>
      <li>Year / 学年:4年</li>
      <li>Student ID / 学籍番号:72240377</li>
      <li>CNS Email / CNSメールアドレス:t22037ri@sfc.keio.ac.jp</li>
    </ul>

    <h3>Collected Data / 収集した行動データ(still, music walking, walking, dribble walking)</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由:いろいろな歩き方を試してどのくらいの粒度で分類できるのか興味を持った。単純な行動の分類じゃなくて、歩きの質を捉えたいと思った。stillはベースラインとして</li>
      <li>Details about collection / 収集についての詳細:stillは直立不動、music walkingは音楽を聴きながら歩いたとき(少しリズムをイメージ)、walkingは普通に歩いたとき、driblle walkingはサッカーボールをドリブルしながら</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点:music walkingとwalkingに大きな違いは生まれなさそうだと思ったので、music walkingの時はリズムを感じながら気持ち大げさに歩いた。</li>
    </ul>

    <h3>Features / 特徴量(max, min, average, variance, absolute sum, kurtosis</h3>
    <ul>
      <li>Reason behind data selection / 選定した理由: music walkingはwalkingに比べ、早いリズムで歩いた。そのため、変化量が多いと感じ、music walkingのほうが合計が大きくなると思った。kurtosisは、ドリブル中はシャープな変化が多いと感じたため</li>
      <li>Details about additional feature types / 追加した特徴量について: absolute sumは絶対値の合計、kurtosisは尖度</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点:変化量が大きいことの定量化がabsolute sumなのは果たして最適なのか。max derivative的ないい指標がありそうだと感じた。</li>
    </ul>    

    <h3>ML Model / 機械学習モデル</h3>
    <ul>
      <li>Algorithm you used and the training result / 採用したアルゴリズムや学習結果の詳細:J48 Pruned tree - correctly classified instances 50% (20/40)</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点: Confusion Matrix上ではmusic walkingとdribblingのご分類が多かった。これらを差別化できる指標が必要だった</li>
    </ul>

    <h3>Real-time execution result / 実機に移植しての性能評価</h3>
    <ul>
      <li>Evaluation metric you used / 評価尺度について:各動作を3回ずつ繰り返し、正しく分類されるかを検証した</li>
      <li>Evaluation results / 評価結果:7/12</li>
      <li>Any challenges and tweaks / 工夫した点・困難だった点: ズボンをはき替えてしまい、環境が変わったため上手く分類ができなくなった。できる限り同じ環境で検証をする</li>
    </ul>

  </body>


<!--  ===========================================  -->
<script type="text/javascript">

alert("Welcome to example Activity Recognition (11).");

//CONFIG: Length of each time window
const NUM_DATA_PER_FRAME = 200;

//Arrays for saving the raw sensor data
var xdata = [];
var ydata = [];
var zdata = [];
var num_data = 0;

//Features
var xmin = 0.0;
var xmax = 0.0;
var xave = 0.0;
var xkurtosis = 0.0;
var xsumabs = 0.0;
var ymin = 0.0;
var ymax = 0.0;
var yave = 0.0;
var ykurtosis = 0.0;
var ysumabs = 0.0;
var zmin = 0.0;
var zmax = 0.0;
var zave = 0.0;
var zkurtosis = 0.0;
var zsumabs = 0.0;

//////////////////////////////////////////////////////
//Function to get sensor access permission from the browser
//////////////////////////////////////////////////////
function requestMotionPermission(){
  if ( DeviceMotionEvent &&
       typeof DeviceMotionEvent.requestPermission === 'function' ){
      // iOS 13+ の Safari
      // 許可を取得
      DeviceMotionEvent.requestPermission().then(permissionState => {
	  if (permissionState === 'granted') {
              // 許可を得られた場合、devicemotionをイベントリスナーに追加
	      window.addEventListener("devicemotion", handleAcceleration, false);
	  } else {
              // 許可を得られなかった場合の処理
	      console.log("Perrmission not granted!");
	      alert("Perrmission not granted!");
	  }
      }).catch(console.error) // https通信でない場合などで許可を取得できなかった場合

  } else {
      //For other devices
      console.log("detected other device. so adding listener...");
      window.addEventListener("devicemotion", handleAcceleration, false);
  }

}

function stopDeviceMotion(){ 
    window.removeEventListener("devicemotion", handleAcceleration, false);
}


////////////////////////////////////////////////////////////////////
//Function(1): 読み込まれてきた最新の加速度データ(X,Y,Z)を処理する関数
//  - この関数は(機種によりますが) 秒速10〜100回というような高頻度で呼ばれます
////////////////////////////////////////////////////////////////////
function handleAcceleration(ev){

    //alert("" + event.acceleration.x + " " + event.acceleration.y + " " + event.acceleration.z);
    $('#accel-x').text( ev.acceleration.x );
    xdata.push(ev.acceleration.x);
    $('#accel-y').text( ev.acceleration.y );
    ydata.push(ev.acceleration.y);
    $('#accel-z').text( ev.acceleration.z );
    zdata.push(ev.acceleration.z);
    $('#raw-data').append(ev.acceleration.x + ", " + ev.acceleration.y + ", " + ev.acceleration.z + "\n");

    num_data++;
    //If we have enough raw sensor data...
    if( num_data == NUM_DATA_PER_FRAME ){

	//execute feature calculations.
	featureExtraction();

	//Let's classify the activity!
	var current_activity = classify();
	$('#current_result').text( current_activity );
	
	//clear the raw sensor data
	xdata=[];
	ydata=[];
	zdata=[];
	//Clear the textarea 
	$('#raw-data').empty();
	//Counter back to 0
	num_data=0;
    }
    
}

////////////////////////////////////////////////////////////////////
//Function(2):センサデータから "feature"(特徴量)を計算する関数
//  - この関数は NUM_DATA_PER_FRAME 変数で設定された数だけセンサデータが
//    「設定されたタイムフレーム」にたまる度に呼ばれます。
//  - 例: センサデータが 50Hz (=50 data / seconds)
//        NUM_DATA_PER_FRAME が 200 の場合
//        → 約4秒に1度の頻度で呼ばれます
////////////////////////////////////////////////////////////////////
//helper func. to calculate average
const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length

function featureExtraction(){
    xmin = Math.min.apply(Math, xdata); $('#xmin').text(xmin);
    xmax = Math.max.apply(Math, xdata); $('#xmax').text(xmax);
    xave = arrAvg(xdata); $('#xave').text(xave);
	xkurtosis = arrKurtosis(xdata, xave);    $('#xkurtosis').text(xkurtosis.toFixed(4));
    xsumabs = xdata.reduce((acc, val) => acc + Math.abs(val), 0); $('#xsumabs').text(xsumabs.toFixed(4)); 
    
    ymin = Math.min.apply(Math, ydata); $('#ymin').text(ymin);
    ymax = Math.max.apply(Math, ydata); $('#ymax').text(ymax);
    yave = arrAvg(ydata); $('#yave').text(yave);
	ykurtosis = arrKurtosis(ydata, yave);    $('#ykurtosis').text(ykurtosis.toFixed(4));
    ysumabs = ydata.reduce((acc, val) => acc + Math.abs(val), 0); $('#ysumabs').text(ysumabs.toFixed(4)); 

    zmax = Math.max.apply(Math, zdata); $('#zmax').text(zmax);
    zmin = Math.min.apply(Math, zdata); $('#zmin').text(zmin);
    zave = arrAvg(zdata); $('#zave').text(zave);
	zkurtosis = arrKurtosis(zdata, zave);    $('#zkurtosis').text(zkurtosis.toFixed(4));
    zsumabs = zdata.reduce((acc, val) => acc + Math.abs(val), 0); $('#zsumabs').text(zsumabs.toFixed(4)); 
}

////////////////////////////////////////////////////////////////////
//Function(3): 最新フレームにおける特徴量(feature)から、現在のユーザの
//行動を分類 (classify) する関数          
//  - ここに書いてあるのは、手打ちで書いたサンプルのif文ロジックです
//  - 実際には機械学習エンジンが出力したif文の固まり (決定木アルゴリズムの場合)
//  - がここに入ります
////////////////////////////////////////////////////////////////////
function classify(){
    
    if (ymax <= 0) {
        return 'still'; // (11.0/1.0)
    } else {
        // ymax > 0
        if (ymax <= 1.4) {
            if (xvariance <= 0.013803) {
                return 'music walking'; // (2.0)
            } else {
                return 'walking'; // (7.0/1.0)
            }
        } else {
            // ymax > 1.4
            if (xmax <= 13.2) {
                if (xmax <= 8.6) {
                    if (ymin <= -4.7) {
                        if (xvariance <= 3.596449) {
                            return 'music walking'; // (2.0)
                        } else {
                            return 'dribbling'; // (3.0/1.0)
                        }
                    } else {
                        // ymin > -4.7
                        return 'dribbling'; // (3.0/1.0)
                    }
                } else {
                    // xmax > 8.6
                    if (zkurtosis <= 16.329331) {
                        return 'walking'; // (4.0/1.0)
                    } else {
                        // zkurtosis > 16.329331
                        if (xave <= 0.228667) {
                            return 'dribbling'; // (3.0/1.0)
                        } else {
                            return 'music walking'; // (2.0)
                        }
                    }
                }
            } else {
                // xmax > 13.2
                return 'dribbling'; // (3.0)
            }
        }
    }
}
	
function arrStdDev(arr, mean) {
    if (arr.length < 2) return 0;
    const n = arr.length;
    const variance = arr.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1);
    return Math.sqrt(variance);
}
function arrKurtosis(arr, mean) {
    if (arr.length < 4) return 0; 

    const n = arr.length;
    
    const m2 = arr.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
    if (m2 === 0) return 0;
    
    const stdDev_pop = Math.sqrt(m2);

    const m4_normalized = arr.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev_pop, 4), 0) / n;

    return m4_normalized - 3;
}

</script>
<!--  ===========================================  -->


</html>
